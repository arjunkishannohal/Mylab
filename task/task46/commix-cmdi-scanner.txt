# Task 46: Commix Command Injection Scanner
# ==============================================================================
# JULES AI AGENT INSTRUCTIONS - FULL BRAIN MODE
# ==============================================================================

## TASK IDENTITY
- **Task Number**: 46
- **Task Name**: Commix Command Injection Scanner
- **Category**: Phase 4 - Injection Testing (Step 12)
- **Depends On**: Tasks 14-18 (parameterized URLs), Task 32 (WAF detection)
- **AI Brain**: commix_scanner.py

## PURPOSE
Automated command injection testing using Commix on ALL parameterized endpoints.
Focuses on standard injection techniques - bypass techniques are in Task 47.

## INPUT FILES

```
PRIMARY SOURCES (parameterized URLs):
â”œâ”€â”€ outputs/queue_dynamic_endpoints_urls.txt      # URLs with query params
â”œâ”€â”€ outputs/arjun_found_params.txt                # Hidden params discovered
â”œâ”€â”€ outputs/zap/injection_candidates.txt          # ZAP-identified injection points
â”œâ”€â”€ outputs/api_endpoints_live.txt                # Live API endpoints
â”œâ”€â”€ outputs/queue_api_endpoints_kiterunner.txt    # Kiterunner API routes
â”œâ”€â”€ outputs/har/common_data.txt                   # HAR-extracted requests

INTELLIGENCE:
â”œâ”€â”€ outputs/waf/waf_results.json                  # WAF detection (Task 32)
â”œâ”€â”€ outputs/nuclei/tech_stack.json                # Tech stack info (Task 35)
```

## OUTPUT FILES

```
outputs/cmdi/
â”œâ”€â”€ commix_vulnerable.txt            # Confirmed CMDi URLs
â”œâ”€â”€ commix_possible.txt              # Possible/timeout CMDi
â”œâ”€â”€ commix_results.json              # Full scan results
â”œâ”€â”€ task47_targets.txt               # Failed targets for Task 47 bypass

outputs/vulnerabilities/
â”œâ”€â”€ CMDI-{hash}-CRITICAL.md          # Per-vulnerability reports
```

## COMMAND-LIKE PARAMETER PATTERNS

The brain should PRIORITIZE these parameters:

```python
# Highest Priority - Direct command execution patterns
CRITICAL_PARAMS = [
    'cmd', 'command', 'exec', 'execute', 'run', 'shell',
    'ping', 'query', 'jump', 'code', 'reg', 'do', 'func',
    'arg', 'option', 'load', 'process', 'step', 'read',
    'function', 'req', 'feature', 'exe', 'module', 'payload',
    'cli', 'daemon', 'upload', 'dir', 'download', 'log',
]

# High Priority - System interaction patterns
SYSTEM_PARAMS = [
    'host', 'ip', 'hostname', 'domain', 'server', 'port',
    'path', 'file', 'folder', 'doc', 'mail', 'email',
    'url', 'uri', 'src', 'source', 'dest', 'destination',
    'to', 'from', 'target', 'address', 'name', 'filename',
]

# Medium Priority - Action/debug patterns
ACTION_PARAMS = [
    'action', 'type', 'mode', 'debug', 'test', 'config',
    'cfg', 'env', 'setting', 'template', 'format', 'output',
    'callback', 'return', 'redirect', 'continue', 'checkout',
]
```

## COMMIX COMMAND STRUCTURE

### Basic Scan (per URL):
```bash
commix --url="{url}" \
    --batch \
    --level=3 \
    --technique=CT \
    --output-dir=temp/task46/commix_output
```

### With POST data:
```bash
commix --url="{url}" \
    --data="{post_body}" \
    --batch \
    --level=3
```

### With cookies/headers:
```bash
commix --url="{url}" \
    --cookie="{cookies}" \
    --headers="Authorization: Bearer {token}" \
    --batch
```

## COMMIX TECHNIQUES

```yaml
# Commix technique codes:
C: Classic (results-based)
E: Eval-based (code evaluation)
T: Time-based blind (sleep detection)
F: File-based (write + check)

# Default: CT (Classic + Time-based) - fastest
# For deeper scan: CETF (all techniques)
```

## INJECTION SEPARATORS

Commix tests these automatically:
```
;      - Command separator (Unix)
|      - Pipe (Unix/Windows)
||     - OR operator
&&     - AND operator
&      - Background (Unix) / separator (Windows)
`cmd`  - Backtick execution (Unix)
$(cmd) - Command substitution (Unix)
\n     - Newline injection
```

## OS DETECTION

Commix auto-detects OS, but brain should also use Nuclei tech detection:

```python
# From Task 35 tech_stack.json
if 'Windows' in detected_tech:
    os_hint = '--os=windows'
elif 'Linux' in detected_tech or 'Apache' in detected_tech:
    os_hint = '--os=unix'
```

## DETECTION METHODS

### 1. Results-based (Classic):
```
Input: ;id
Output contains: uid=1000(user)...
â†’ VULNERABLE
```

### 2. Time-based Blind:
```
Input: ;sleep 5
Response time: >5 seconds
â†’ VULNERABLE (blind)
```

### 3. File-based:
```
Input: ;echo test > /tmp/test.txt
Check: ;cat /tmp/test.txt
Output: test
â†’ VULNERABLE
```

## AI BRAIN LOGIC

```
1. COLLECT TARGETS
   â”œâ”€â”€ Load all parameterized URLs
   â”œâ”€â”€ Prioritize by param name (cmd > host > action)
   â””â”€â”€ Load WAF info for adaptive testing

2. FOR EACH TARGET:
   a. Check if param is high-value (cmd, exec, ping, etc.)
   b. Determine likely OS from tech detection
   c. Run commix with appropriate options
   d. Parse output for vulnerability indicators
   e. If vulnerable: generate report
   f. If WAF-blocked/timeout: add to task47_targets.txt

3. CATEGORIZE RESULTS:
   - vulnerable â†’ outputs/cmdi/commix_vulnerable.txt
   - possible   â†’ outputs/cmdi/commix_possible.txt  
   - waf_blocked â†’ task47_targets.txt (for bypass)
   - clean      â†’ skip

4. GENERATE REPORTS:
   - Per-vuln: CMDI-{hash}-CRITICAL.md
```

## VULNERABILITY REPORT TEMPLATE

```markdown
# Command Injection: CMDI-{hash}

## Summary
| Field | Value |
|-------|-------|
| **ID** | CMDI-{hash} |
| **URL** | {url} |
| **Parameter** | {param} |
| **Technique** | {classic/time-based/file-based} |
| **OS** | {linux/windows} |
| **Severity** | CRITICAL |

## Proof of Concept
```bash
# Reproduce with:
commix --url="{url}" --batch
```

## Payload
```
{payload}
```

## Evidence
```
{commix_output}
```

## Impact
- Remote Code Execution (RCE)
- Full server compromise
- Data exfiltration
- Lateral movement

## Recommendations
1. Never pass user input to shell commands
2. Use allowlist validation for expected values
3. Use parameterized APIs (subprocess with list args)
4. Implement WAF rules for command injection
```

## EXECUTION FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load parameterized URLs from:          â”‚
â”‚  - queue_dynamic_endpoints_urls.txt     â”‚
â”‚  - arjun_found_params.txt               â”‚
â”‚  - api_endpoints_live.txt               â”‚
â”‚  - zap/injection_candidates.txt         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prioritize by parameter name:          â”‚
â”‚  cmd/exec/ping â†’ CRITICAL (test first)  â”‚
â”‚  host/file/path â†’ HIGH                  â”‚
â”‚  action/type â†’ MEDIUM                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  For each URL (9-min batches):          â”‚
â”‚  1. Run: commix --url X --batch         â”‚
â”‚  2. Parse output for vulns              â”‚
â”‚  3. If blocked â†’ add to Task 47 queue   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Output:                                â”‚
â”‚  - commix_vulnerable.txt                â”‚
â”‚  - task47_targets.txt (for bypass)      â”‚
â”‚  - CMDI-*.md reports                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## TIME MANAGEMENT

```
Commix per-URL timing:
- Quick scan (level 1): ~30 seconds
- Standard scan (level 3): ~2-3 minutes
- Deep scan (level 5): ~5-10 minutes

Strategy:
- Use level 3 for high-priority params
- Use level 1 for low-priority params
- Batch limit: ~50-100 URLs per 9 minutes
```

## HOW TO RUN

```bash
# Full scan
python commix_scanner.py --workspace d:\wallet\Mylab

# High-priority params only
python commix_scanner.py --workspace d:\wallet\Mylab --priority-only

# Resume from checkpoint
python commix_scanner.py --workspace d:\wallet\Mylab --resume

# Specific URL test
python commix_scanner.py --workspace d:\wallet\Mylab --url "http://target/?cmd=test"
```

## HANDOFF TO TASK 47

If Commix fails due to WAF or no results on suspicious params:
```
outputs/cmdi/task47_targets.txt
```

Task 47 will:
1. Use advanced bypass techniques (${IFS}, base64, etc.)
2. Use OOB callbacks via Interactsh
3. Catch blind CMDi that Commix misses

## AI AGENT CREATIVITY DIRECTIVE

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  YOU ARE AN INTELLIGENT AGENT ğŸ§                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Commix is automated, but YOU decide how to use it intelligently.            â”‚
â”‚                                                                             â”‚
â”‚ PRIORITIZE SMARTLY:                                                         â”‚
â”‚                                                                             â”‚
â”‚ 1. HIGHEST PRIORITY - Direct command params:                                â”‚
â”‚    cmd, exec, command, shell, run, ping, host, ip                           â”‚
â”‚    â†’ These SCREAM command injection. Test thoroughly.                       â”‚
â”‚                                                                             â”‚
â”‚ 2. MEDIUM PRIORITY - System interaction params:                             â”‚
â”‚    file, path, dir, url, domain, server                                     â”‚
â”‚    â†’ May pass to system commands internally.                                â”‚
â”‚                                                                             â”‚
â”‚ 3. LOWER PRIORITY - Generic params:                                         â”‚
â”‚    action, type, mode, debug                                                â”‚
â”‚    â†’ Quick test, don't waste time if no response.                           â”‚
â”‚                                                                             â”‚
â”‚ OBSERVE THE BACKEND:                                                        â”‚
â”‚                                                                             â”‚
â”‚ â€¢ Linux server? â†’ Test: id, whoami, cat /etc/passwd                         â”‚
â”‚ â€¢ Windows server? â†’ Test: whoami, dir, type                                 â”‚
â”‚ â€¢ Unknown? â†’ Test both command sets                                         â”‚
â”‚                                                                             â”‚
â”‚ ANALYZE RESPONSES:                                                          â”‚
â”‚                                                                             â”‚
â”‚ â€¢ Response time changed? â†’ Possible time-based blind injection              â”‚
â”‚ â€¢ Error message appeared? â†’ Read it! Reveals command processing             â”‚
â”‚ â€¢ Different response length? â†’ Command output may be embedded               â”‚
â”‚                                                                             â”‚
â”‚ DON'T GIVE UP ON FAILURES:                                                  â”‚
â”‚ â€¢ No results? â†’ Send to Task 47 for bypass techniques                       â”‚
â”‚ â€¢ WAF blocked? â†’ Note WAF type, Task 47 will handle                         â”‚
â”‚ â€¢ Timeout? â†’ Mark as possible, needs manual verification                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
